<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gün 02: Lines - İnteraktif Vapur Ağı</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <!-- Animasyon hesaplamaları için Turf.js kütüphanesini ekliyoruz -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow: hidden; background-color: #f0f2f5; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .header {
            position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            color: #1a1a1a; padding: 20px 30px; border-radius: 16px; z-index: 1; max-width: 380px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { font-size: 22px; margin: 0 0 8px 0; }
        .header p { font-size: 14px; margin: 0; color: #555; }
        .back-button {
            position: absolute; bottom: 20px; left: 20px; background: #fff; color: #333; text-decoration: none;
            padding: 10px 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-weight: 600; z-index: 2; transition: all 0.2s ease;
        }
        .back-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        
        .maplibregl-popup-content {
            background: rgba(255, 255, 255, 0.95); color: #1a1a1a; padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
            max-width: 280px;
        }
        .maplibregl-popup-close-button { color: #333; }
        .popup-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .popup-details ul { list-style: none; padding: 0; margin: 10px 0 0 0; }
        .popup-details li { margin-bottom: 5px; font-size: 0.9rem; }
        .popup-details a { color: #007aff; text-decoration: none; }
        .popup-details a:hover { text-decoration: underline; }
        
        .legend {
            position: absolute; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1; border: 1px solid rgba(0,0,0,0.05);
        }
        .legend h3 { margin: 0 0 10px 0; font-size: 16px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 15px; height: 15px; border-radius: 50%; margin-right: 10px; }
        .legend-label { font-size: 13px; }
    </style>
</head>
<body>
    <a href="../index.html" class="back-button">❮ Ana Sayfa</a>
    <div id="map"></div>
    <div class="header">
        <h1>İstanbul Vapur Ağı</h1>
        <p>Hatlar üzerinde hareket eden vapurları izleyin ve iskelelere tıklayarak bilgi alın.</p>
    </div>
    <div class="legend">
        <!-- Lejant aynı kalabilir -->
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'carto-light': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OpenStreetMap contributors © CARTO' } },
                layers: [{ id: 'carto-light-layer', type: 'raster', source: 'carto-light' }]
            },
            center: [29.05, 41.00],
            zoom: 10.5,
            antialias: true
        });

        map.on('load', async () => {
            const response = await fetch('../data/vapur.geojson');
            const ferryData = await response.json();
            const ferryLines = ferryData.features.filter(f => f.geometry.type === "LineString");

            map.addSource('osm-ferry-data', { type: 'geojson', data: ferryData });

            // İskele ve hat katmanları
            map.addLayer({ 'id': 'pier-fills', 'type': 'fill', 'source': 'osm-ferry-data', 'filter': ['==', ['geometry-type'], 'Polygon'], 'paint': { 'fill-color': '#aaccff', 'fill-opacity': 0.5 } });
            map.addLayer({ 'id': 'pier-outlines', 'type': 'line', 'source': 'osm-ferry-data', 'filter': ['==', ['geometry-type'], 'Polygon'], 'paint': { 'line-color': '#557799', 'line-width': 1.5 } });
            map.addLayer({
                'id': 'ferry-routes', 'type': 'line', 'source': 'osm-ferry-data', 'filter': ['==', ['geometry-type'], 'LineString'], 'layout': { 'line-join': 'round', 'line-cap': 'round' },
                'paint': { 'line-width': 2.5, 'line-color': ['match', ['get', 'operator'], 'Şehir Hatları', '#e63946', 'Turyol', '#1d3557', 'Dentur', '#457b9d', 'Dentur Avrasya', '#457b9d', '#a8dadc'] }
            });
            map.addLayer({ 'id': 'pier-labels', 'type': 'symbol', 'source': 'osm-ferry-data', 'filter': ['==', ['geometry-type'], 'Polygon'], 'layout': { 'text-field': ['get', 'name'], 'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'], 'text-size': 12, 'text-variable-anchor': ['top', 'bottom', 'left', 'right'], 'text-radial-offset': 0.5, 'text-justify': 'auto' }, 'paint': { 'text-color': '#222', 'text-halo-color': 'rgba(255,255,255,0.8)', 'text-halo-width': 1 } });
            
            // Animasyon kodları
            map.loadImage('../data/ship.png', (error, image) => {
                if (error) throw error;
                map.addImage('ship-icon', image);
                const ships = { type: 'FeatureCollection', features: ferryLines.map((line, index) => turf.point(line.geometry.coordinates[0], { lineIndex: index, distance: 0, bearing: 0 })) };
                map.addSource('ships-source', { type: 'geojson', data: ships });
                map.addLayer({ 'id': 'ships-layer', 'type': 'symbol', 'source': 'ships-source', 'layout': { 'icon-image': 'ship-icon', 'icon-size': 0.05, 'icon-rotate': ['get', 'bearing'], 'icon-rotation-alignment': 'map', 'icon-allow-overlap': true, 'icon-ignore-placement': true } });
                animateShips();
            });
            let startTime = 0;
            function animateShips() { /* Animasyon kodu burada, değişiklik yok */ }
            
            // --- YENİ EKLENEN ETKİLEŞİM KODLARI ---

            const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });

            // 1. Hatların üzerine gelince popup gösterme
            map.on('mouseenter', 'ferry-routes', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const properties = e.features[0].properties;
                const routeName = properties.name || 'İsimsiz Hat';
                const operatorName = properties.operator || 'Bilinmiyor';
                popup.setLngLat(e.lngLat).setHTML(`<strong>${routeName}</strong><br><em>Operatör: ${operatorName}</em>`).addTo(map);
            });
            map.on('mouseleave', 'ferry-routes', () => {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // 2. İskelelerin üzerine gelince imleci değiştirme
            map.on('mouseenter', 'pier-fills', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'pier-fills', () => {
                map.getCanvas().style.cursor = '';
            });

            // 3. İskelelere tıklayınca detaylı popup gösterme
            map.on('click', 'pier-fills', (e) => {
                const properties = e.features[0].properties;

                // Popup için HTML içeriğini oluştur
                let htmlContent = `<div class="popup-title">${properties.name || 'İsimsiz İskele'}</div>`;
                htmlContent += `<div class="popup-details"><ul>`;
                
                if (properties.operator) {
                    htmlContent += `<li><strong>Operatör:</strong> ${properties.operator}</li>`;
                }
                if (properties.alt_name) {
                    htmlContent += `<li><strong>Diğer Adı:</strong> ${properties.alt_name}</li>`;
                }

                // OSM linki oluştur
                const osmId = properties['@id'];
                if (osmId) {
                    const [type, id] = osmId.split('/');
                    const osmUrl = `https://www.openstreetmap.org/${type}/${id}`;
                    htmlContent += `<li><a href="${osmUrl}" target="_blank">OpenStreetMap'te Görüntüle</a></li>`;
                }

                // Wikipedia linki oluştur
                const wiki = properties.wikipedia;
                if (wiki) {
                    const [lang, page] = wiki.split(':');
                    const wikiUrl = `https://://${lang}.wikipedia.org/wiki/${encodeURIComponent(page.replace(/ /g, '_'))}`;
                    htmlContent += `<li><a href="${wikiUrl}" target="_blank">Vikipedi'de Oku</a></li>`;
                }

                htmlContent += `</ul></div>`;
                
                // Yeni bir popup oluştur ve göster
                new maplibregl.Popup({closeButton: true, closeOnClick: true})
                    .setLngLat(e.lngLat)
                    .setHTML(htmlContent)
                    .addTo(map);
            });
        });

        // Animasyon fonksiyonu (önceki cevaptan kopyalandı, değişiklik yok)
        let startTime = 0;
        function animateShips(timestamp) {
            if (!map.getSource('ships-source')) return; // Kaynak henüz yüklenmediyse bekle
            if (!startTime) startTime = timestamp;
            const speed = 0.02; 
            const shipsSource = map.getSource('ships-source');
            const shipsData = shipsSource._data;
            const ferryLines = shipsData.features.map(ship => map.querySourceFeatures('osm-ferry-data', {filter: ['==', ['get', 'lineIndex'], ship.properties.lineIndex]})[0]);

            shipsData.features.forEach((ship, i) => {
                const line = ferryLines[i].geometry;
                const lineDistance = turf.length(line, { units: 'kilometers' });
                ship.properties.distance = (ship.properties.distance + speed / 60) % lineDistance;
                const newPoint = turf.along(line, ship.properties.distance, { units: 'kilometers' });
                ship.geometry.coordinates = newPoint.geometry.coordinates;
                const pointSlightlyAhead = turf.along(line, ship.properties.distance + 0.01, { units: 'kilometers' });
                ship.properties.bearing = turf.bearing(newPoint, pointSlightlyAhead);
            });
            shipsSource.setData(shipsData);
            requestAnimationFrame(animateShips);
        }
    </script>
</body>
</html>