<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gün 03: Polygons - İnteraktif Kültür Haritası</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        /* CSS'te değişiklik yok, aynı kalabilir */
        body { margin: 0; background-color: #f0f2f5; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .header { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #1a1a1a; padding: 20px 30px; border-radius: 16px; z-index: 2; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .header h1 { font-size: 22px; margin: 0 0 8px 0; }
        .header p { font-size: 14px; margin: 0; color: #555; }
        .back-button { position: absolute; bottom: 20px; left: 20px; background: #fff; color: #333; text-decoration: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; z-index: 2; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .maplibregl-popup-content { background: rgba(255, 255, 255, 0.95); color: #1a1a1a; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); max-width: 320px; max-height: 400px; overflow-y: auto; }
        .maplibregl-popup-close-button { color: #333; }
        .popup-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; }
        .popup-count { font-size: 1.5rem; font-weight: 700; color: #cb181d; }
        .popup-list-title { margin-top: 15px; font-weight: 600; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .popup-list { list-style: decimal; padding-left: 20px; margin-top: 10px; font-size: 0.9rem; }
        .popup-list li { margin-bottom: 5px; }
        .popup-list-footer { font-size: 0.8rem; color: #999; margin-top: 10px; }
        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 10; display: flex; align-items: center; justify-content: center; color: #333; font-size: 1.2rem; text-align: center; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>
    <a href="../index.html" class="back-button">❮ Ana Sayfa</a>
    <div id="loader"><p>Veriler analiz ediliyor...</p><p><small>(Bu işlem birkaç saniye sürebilir)</small></p></div>
    <div id="map"></div>
    <div class="header">
        <h1>İstanbul'un Kültürel Yoğunluk Haritası</h1>
        <p>İlçelere tıklayarak hem detaylı listeyi hem de tarihi yapıların konumlarını haritada görün.</p>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'carto-light': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'], tileSize: 256 } },
                layers: [{ id: 'carto-light-layer', type: 'raster', source: 'carto-light' }]
            },
            center: [28.97, 41.05],
            zoom: 9.5, pitch: 0, bearing: 0, antialias: true
        });
        
        const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true });

        // Popup kapatıldığında temizlik yapacak fonksiyon
        popup.on('close', () => {
            // Vurgu katmanını ve kaynağını kaldır
            if (map.getLayer('district-highlight')) map.removeLayer('district-highlight');
            if (map.getSource('highlight-source')) map.removeSource('highlight-source');
            
            // Tarihi noktalar katmanını tekrar gizle
            map.setLayoutProperty('historic-points', 'visibility', 'none');
        });

        map.on('load', async () => {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';

            const [districtsResponse, pointsResponse] = await Promise.all([ fetch('../data/ilceler.geojson'), fetch('../data/tarihi_noktalar.geojson') ]);
            let districtsData = await districtsResponse.json();
            let pointsData = await pointsResponse.json();
            const districtPolygons = districtsData.features.filter(f => f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon'));
            const historicPoints = pointsData.features.filter(f => f.geometry && f.geometry.type === 'Point' && Array.isArray(f.geometry.coordinates) && f.geometry.coordinates.length >= 2);
            
            // --- DEĞİŞİKLİK: Artık analizde 'id' de saklıyoruz ---
            districtPolygons.forEach((district, index) => {
                district.id = index; // Her ilçeye benzersiz bir ID ata
                district.properties.tarihi_yapi_sayisi = 0;
                district.properties.tarihi_yapilar = [];
            });
            historicPoints.forEach(point => {
                for (const district of districtPolygons) {
                    if (turf.booleanPointInPolygon(point, district)) {
                        district.properties.tarihi_yapi_sayisi++;
                        if (point.properties && point.properties.name) {
                            district.properties.tarihi_yapilar.push(point.properties.name);
                        }
                        // Bu noktanın hangi ilçeye ait olduğunu belirt
                        point.properties.ilce_id = district.id; 
                        break; 
                    }
                }
            });
            districtsData.features = districtPolygons;
            pointsData.features = historicPoints;
            
            map.addSource('districts-source', { type: 'geojson', data: districtsData });
            // --- YENİ KAYNAK: Tüm tarihi noktalar için kaynak ekle ---
            map.addSource('historic-points-source', { type: 'geojson', data: pointsData });

            // İlçe dolgu katmanı
            map.addLayer({
                'id': 'districts-fill', 'type': 'fill', 'source': 'districts-source',
                'paint': {
                    'fill-color': ['interpolate', ['linear'], ['get', 'tarihi_yapi_sayisi'], 0, '#fee0d2', 10, '#fcbba1', 50, '#fc9272', 150, '#fb6a4a', 400, '#ef3b2c', 800, '#cb181d', 1500, '#99000d'],
                    'fill-opacity': 0.8, 'fill-outline-color': '#ffffff'
                }
            });

            // --- YENİ KATMAN: Tarihi Noktalar (başlangıçta gizli) ---
            map.addLayer({
                id: 'historic-points',
                type: 'circle',
                source: 'historic-points-source',
                paint: {
                    'circle-radius': 4,
                    'circle-color': '#000000',
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1
                },
                layout: {
                    'visibility': 'none' // Başlangıçta görünmez
                }
            });

            // İlçe etiketleri katmanı
            map.addLayer({ /* ... önceki kodla aynı ... */ });

            map.on('click', 'districts-fill', (e) => {
                const clickedDistrict = e.features[0];
                const props = clickedDistrict.properties;
                const districtId = clickedDistrict.id;

                // 1. Vurgu katmanını oluştur/güncelle
                if (map.getSource('highlight-source')) {
                    map.getSource('highlight-source').setData(clickedDistrict.geometry);
                } else {
                    map.addSource('highlight-source', { 'type': 'geojson', 'data': clickedDistrict.geometry });
                    map.addLayer({
                        'id': 'district-highlight', 'type': 'line', 'source': 'highlight-source',
                        'paint': { 'line-color': '#000', 'line-width': 3 }
                    });
                }
                
                // 2. Tarihi noktalar katmanını filtrele ve görünür yap
                map.setFilter('historic-points', ['==', 'ilce_id', districtId]);
                map.setLayoutProperty('historic-points', 'visibility', 'visible');
                
                // 3. Popup'ı göster
                const totalCount = props.tarihi_yapi_sayisi || 0;
                let listHtml = '';
                if (props.tarihi_yapilar && props.tarihi_yapilar.length > 0) {
                    const yapilar = JSON.parse(props.tarihi_yapilar);
                    const listItems = yapilar.slice(0, 10).map(name => `<li>${name}</li>`).join('');
                    listHtml = `<div class="popup-list-title">Öne Çıkan Yapılar</div><ol class="popup-list">${listItems}</ol>`;
                    if (yapilar.length > 10) { listHtml += `<div class="popup-list-footer">... ve ${yapilar.length - 10} diğer yapı</div>`; }
                }
                const html = `<div class="popup-title">${props.name}</div><div><span class="popup-count">${totalCount.toLocaleString('tr-TR')}</span><span> Tarihi Yapı</span></div>${listHtml}`;
                popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
            });

            map.on('mouseenter', 'districts-fill', () => { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'districts-fill', () => { map.getCanvas().style.cursor = ''; });

            loader.style.display = 'none';
        });
    </script>
</body>
</html>