<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GÃ¼n 08: Urban - Kocaeli Voronoi Toplanma AlanlarÄ±</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .header {
            position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            color: #1a1a1a; padding: 20px 30px; border-radius: 16px; z-index: 2; max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { font-size: 22px; margin: 0 0 8px 0; }
        .header p { font-size: 14px; margin: 0; color: #555; }
        .back-button {
            position: absolute; bottom: 20px; left: 20px; background: #fff; color: #333;
            text-decoration: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; z-index: 2;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .maplibregl-popup-content { padding: 20px; max-width: 300px; }
        .popup-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; }
        .popup-info { font-size: 0.9rem; color: #333; }
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 10;
            display: flex; align-items: center; justify-content: center;
            color: #333; font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-button">â® Ana Sayfa</a>
    <div id="loader">Voronoi diyagramÄ± oluÅŸturuluyor...</div>
    <div id="map"></div>
    <div class="header">
        <h1>ğŸ™ï¸ Kocaeli Toplanma AlanlarÄ±</h1>
        <p><strong>Voronoi DiyagramÄ±:</strong> Her bÃ¶lge, kendisine en yakÄ±n toplanma alanÄ±nÄ± gÃ¶sterir.</p>
        <p style="margin-top: 10px; font-size: 13px; color: #666;">
            <span style="color: #2ecc71;">ğŸŸ¢ YeÅŸil:</span> KÃ¼Ã§Ã¼k alan (kolay eriÅŸim)<br>
            <span style="color: #f39c12;">ğŸŸ¡ SarÄ±:</span> Orta alan<br>
            <span style="color: #e74c3c;">ğŸ”´ KÄ±rmÄ±zÄ±:</span> GeniÅŸ alan (uzak eriÅŸim)
        </p>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'basemap': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'], tileSize: 256 } },
                layers: [{ id: 'basemap-layer', type: 'raster', source: 'basemap' }]
            },
            center: [29.9, 40.78], // Kocaeli merkez
            zoom: 10,
            antialias: true
        });

        map.on('load', async () => {
            const loader = document.getElementById('loader');

            // 1. Kocaeli toplanma alanÄ± verisini yÃ¼kle
            const response = await fetch('../data/toplanma alani kocaeli/acil-toplanma-alanlar.json');
            const pointsData = await response.json();

            // 2. Turf.js ile Voronoi diyagramÄ±nÄ± oluÅŸtur
            console.log("Voronoi diyagramÄ± hesaplanÄ±yor...");
            console.log("Toplam nokta sayÄ±sÄ±:", pointsData.features.length);
            
            const options = {
                // Kocaeli'nin yaklaÅŸÄ±k sÄ±nÄ±rlayÄ±cÄ± kutusu (bounding box)
                bbox: [29.3, 40.5, 30.4, 41.2] 
            };
            
            let voronoiPolygons;
            try {
                voronoiPolygons = turf.voronoi(pointsData, options);
                console.log("Voronoi oluÅŸturuldu, poligon sayÄ±sÄ±:", voronoiPolygons.features.length);
            } catch (error) {
                console.error("Voronoi oluÅŸturma hatasÄ±:", error);
                loader.textContent = "Hata: Voronoi oluÅŸturulamadÄ± - " + error.message;
                return;
            }

            // 3. Her Voronoi hÃ¼cresine alan bilgisi ekle
            voronoiPolygons.features.forEach((polygon, i) => {
                if (pointsData.features[i]) {
                    polygon.properties = {...pointsData.features[i].properties};
                    polygon.properties.voronoi_id = i;
                    
                    // Poligon alanÄ±nÄ± hesapla (kmÂ²)
                    const area = turf.area(polygon) / 1000000; // mÂ² to kmÂ²
                    polygon.properties.area_km2 = area;
                }
            });
            console.log("Voronoi diyagramÄ± hazÄ±r, haritaya ekleniyor...");

            // 4. Voronoi poligonlarÄ±nÄ± haritaya ekle
            map.addSource('voronoi-source', {
                type: 'geojson',
                data: voronoiPolygons
            });
            
            console.log("Voronoi source eklendi");
            
            // Voronoi dolgu katmanÄ± - Alan bÃ¼yÃ¼klÃ¼ÄŸÃ¼ne gÃ¶re renklendirme
            map.addLayer({
                id: 'voronoi-fill',
                type: 'fill',
                source: 'voronoi-source',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'area_km2'],
                        0, '#2ecc71',      // YeÅŸil: KÃ¼Ã§Ã¼k alan (0-2 kmÂ²)
                        2, '#3498db',      // Mavi: KÃ¼Ã§Ã¼k-orta
                        5, '#f39c12',      // SarÄ±: Orta alan (5-10 kmÂ²)
                        10, '#e67e22',     // Turuncu: Orta-bÃ¼yÃ¼k
                        20, '#e74c3c',     // KÄ±rmÄ±zÄ±: BÃ¼yÃ¼k alan (20+ kmÂ²)
                        50, '#c0392b'      // Koyu kÄ±rmÄ±zÄ±: Ã‡ok bÃ¼yÃ¼k alan
                    ],
                    'fill-opacity': 0.6
                }
            });
            
            // Voronoi sÄ±nÄ±r Ã§izgileri
            map.addLayer({
                id: 'voronoi-outline',
                type: 'line',
                source: 'voronoi-source',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });
            
            console.log("Voronoi katmanlarÄ± eklendi");

            // 5. Orijinal toplanma alanÄ± noktalarÄ±nÄ± da haritaya ekle
            map.addSource('points-source', {
                type: 'geojson',
                data: pointsData
            });
            map.addLayer({
                id: 'points-layer',
                type: 'circle',
                source: 'points-source',
                paint: {
                    'circle-radius': [
                        'interpolate', ['linear'], ['zoom'],
                        10, 3,
                        15, 6
                    ],
                    'circle-color': '#000000',
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 2
                }
            });
            
            console.log("Nokta katmanÄ± eklendi");

            // 6. Ä°nteraktiflik
            const popup = new maplibregl.Popup({ closeButton: true, closeOnClick: true });
            
            map.on('click', 'voronoi-fill', (e) => {
                const props = e.features[0].properties;
                const area = props.area_km2 ? props.area_km2.toFixed(2) : 'N/A';
                
                // Alan bÃ¼yÃ¼klÃ¼ÄŸÃ¼ne gÃ¶re yorum
                let areaComment = '';
                if (props.area_km2 < 2) {
                    areaComment = 'ğŸŸ¢ KÃ¼Ã§Ã¼k hizmet alanÄ± - Ä°yi eriÅŸim';
                } else if (props.area_km2 < 10) {
                    areaComment = 'ğŸŸ¡ Orta hizmet alanÄ± - Kabul edilebilir eriÅŸim';
                } else {
                    areaComment = 'ğŸ”´ GeniÅŸ hizmet alanÄ± - Ek toplanma alanÄ± gerekebilir';
                }
                
                const html = `
                    <div class="popup-title">ğŸ“ ${props.adi || 'Toplanma AlanÄ±'}</div>
                    <div class="popup-info">
                        <strong>ğŸ—ºï¸ Hizmet AlanÄ±:</strong> ${area} kmÂ²<br>
                        <em style="color: #666; font-size: 0.85rem;">${areaComment}</em><br><br>
                        <strong>ğŸ“ Adres:</strong> ${props.adres || 'BelirtilmemiÅŸ'}<br>
                        ${props.telefon && props.telefon.trim() && props.telefon !== ' ' ? `<strong>ğŸ“ Telefon:</strong> ${props.telefon}<br>` : ''}
                        <strong>ğŸ·ï¸ Tip:</strong> ${props.ozel_kateg || 'Toplanma AlanÄ±'}
                    </div>`;
                
                popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
            });

            map.on('mouseenter', 'voronoi-fill', () => { 
                map.getCanvas().style.cursor = 'pointer'; 
            });
            map.on('mouseleave', 'voronoi-fill', () => { 
                map.getCanvas().style.cursor = ''; 
            });

            console.log("TÃ¼m katmanlar hazÄ±r!");
            loader.style.display = 'none';
        });
    </script>
</body>
</html>